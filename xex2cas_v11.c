/*--------------------------------------------------------------------*/
/* XEX2CAS - GienekP                                                  */
/*--------------------------------------------------------------------*/
#include <stdio.h>
/*--------------------------------------------------------------------*/
typedef unsigned char U8;
/*--------------------------------------------------------------------*/
/* "! File" */
const U8 exma[560] = {
    0x20, 0x05, 0x00, 0x07, 0x20, 0x07, 0x20, 0xF4, 0x08, 0x4C, 0xED, 0xF2, 0x56, 0xFF, 0x55, 0x57,
    0x52, 0x03, 0x40, 0x2F, 0xEF, 0x17, 0x2F, 0x07, 0x37, 0x2F, 0x0A, 0x56, 0xFE, 0x72, 0x03, 0x40,
    0x52, 0x03, 0x40, 0x0F, 0xF9, 0xE7, 0x97, 0x97, 0xB3, 0xAF, 0xF8, 0x56, 0xFE, 0x72, 0x0F, 0xFD,
    0x56, 0xF8, 0x72, 0xAD, 0xFF, 0x56, 0xF5, 0x72, 0xAA, 0xFF, 0x72, 0xAB, 0xFF, 0x5D, 0x01, 0x5F,
    0xF7, 0xDF, 0x7A, 0x0C, 0xDF, 0x1D, 0x09, 0x36, 0xE4, 0x2F, 0x06, 0x97, 0x97, 0xB3, 0xA4, 0xF8,
    0x56, 0xA4, 0x72, 0xF5, 0xFF, 0x56, 0xF8, 0x72, 0xF4, 0xFF, 0x15, 0x56, 0xFD, 0x72, 0xAD, 0xFF,
    0x56, 0xFF, 0x72, 0x0F, 0xFD, 0x56, 0x82, 0xDF, 0x5B, 0x09, 0xDF, 0x1A, 0xF7, 0x5D, 0xEF, 0x56,
    0xFC, 0x62, 0xBD, 0xFC, 0x56, 0x04, 0x62, 0xBB, 0xFC, 0x56, 0xF7, 0x62, 0xBA, 0xFC, 0x56, 0xFB,
    0x62, 0xB5, 0xFC, 0x56, 0x7F, 0x62, 0xB4, 0xFC, 0x56, 0xF3, 0x72, 0x03, 0xFD, 0xDF, 0xA9, 0x1B,
    0x56, 0xFF, 0x72, 0xC9, 0xF6, 0x5D, 0xEF, 0x56, 0xCB, 0x62, 0xBB, 0xFC, 0x56, 0xF6, 0x62, 0xBA,
    0xFC, 0x56, 0xFD, 0x62, 0xB7, 0xFC, 0x56, 0xFF, 0x62, 0xB6, 0xFC, 0x56, 0xF8, 0x62, 0xBD, 0xFC,
    0xDF, 0xA9, 0x1B, 0xCF, 0xDA, 0x5D, 0xEF, 0x56, 0xCF, 0x62, 0xBB, 0xFC, 0x56, 0xF6, 0x62, 0xBA,
    0xFC, 0x56, 0xFB, 0x62, 0xB7, 0xFC, 0x56, 0xFF, 0x62, 0xB6, 0xFC, 0xDF, 0xA9, 0x1B, 0xEF, 0xE6,
    0x3F, 0x77, 0x2F, 0xF9, 0xDF, 0x1A, 0xF7, 0xB3, 0x82, 0xF7, 0x67, 0xB7, 0xDF, 0x1A, 0xF7, 0x97,
    0x57, 0x0F, 0xF9, 0xDF, 0x7E, 0x0C, 0xB3, 0x82, 0xF7, 0x52, 0xC9, 0xF6, 0x2F, 0xF0, 0x52, 0xCF,
    0xF6, 0x72, 0x1F, 0xFD, 0x52, 0xCE, 0xF6, 0x72, 0x1E, 0xFD, 0x31, 0xC9, 0xF6, 0x5D, 0xEF, 0x52,
    0xCF, 0xF6, 0x62, 0xBB, 0xFC, 0xB7, 0x52, 0xCE, 0xF6, 0x62, 0xBA, 0xFC, 0x57, 0x97, 0x37, 0x2F,
    0xE0, 0x57, 0x37, 0x2F, 0xE4, 0x52, 0xCD, 0xF6, 0x72, 0xCF, 0xF6, 0x52, 0xCC, 0xF6, 0x72, 0xCE,
    0xF6, 0x56, 0xCD, 0x62, 0xBB, 0xFC, 0x56, 0xF6, 0x62, 0xBA, 0xFC, 0x56, 0xFD, 0xB3, 0x3C, 0xF8,
    0x52, 0xCD, 0xF6, 0xC7, 0x12, 0xCF, 0xF6, 0x62, 0xB7, 0xFC, 0x52, 0xCC, 0xF6, 0x12, 0xCE, 0xF6,
    0x62, 0xB6, 0xFC, 0x52, 0xCE, 0xF6, 0x01, 0xB7, 0xFC, 0x2F, 0xFC, 0x01, 0xB6, 0xFC, 0x5D, 0xEF,
    0x56, 0x0C, 0x72, 0x1D, 0xFD, 0x56, 0xF7, 0x72, 0x1C, 0xFD, 0xDF, 0xA9, 0x1B, 0xEF, 0xFC, 0xB3,
    0x25, 0xF8, 0x56, 0xFF, 0x72, 0xBB, 0xFD, 0x56, 0xFE, 0x7A, 0xF6, 0x15, 0x15, 0x15, 0xDF, 0x6D,
    0xF7, 0xDF, 0x85, 0xF7, 0xDF, 0x30, 0xF7, 0xB3, 0x4A, 0xF8, 0x93, 0x1D, 0xFD, 0x56, 0xFF, 0x72,
    0xBB, 0xFD, 0x56, 0xFE, 0x7A, 0xF6, 0x15, 0x15, 0x15, 0xDF, 0x6D, 0xF7, 0xDF, 0x30, 0xF7, 0x93,
    0x1F, 0xFD, 0x56, 0x63, 0x72, 0xFD, 0xFF, 0x56, 0x0C, 0x72, 0xFC, 0xFF, 0x60, 0xA9, 0x0C, 0x8D,
    0xD0, 0x00, 0xA9, 0x07, 0x8D, 0xD1, 0x00, 0xA0, 0x00, 0xB1, 0xD0, 0x49, 0xFF, 0x91, 0xD0, 0xEE,
    0xD0, 0x00, 0xD0, 0x03, 0xEE, 0xD1, 0x00, 0xAD, 0xD1, 0x00, 0xC9, 0x08, 0xD0, 0xE9, 0xAD, 0xD0,
    0x00, 0xC9, 0x9C, 0xD0, 0xE2, 0xA9, 0x00, 0x8D, 0xD0, 0x00, 0x8D, 0xD1, 0x00, 0xEA, 0x60, 0xA9,
    0x3C, 0x8D, 0x02, 0xD3, 0x60, 0xA9, 0x20, 0x8D, 0x09, 0x07, 0xA9, 0x9D, 0x8D, 0x0A, 0x07, 0xA9,
    0x08, 0x8D, 0x0B, 0x07, 0x60, 0xA2, 0x10, 0xA9, 0x0C, 0x20, 0x56, 0xE4, 0xA2, 0x20, 0xA9, 0x0C,
    0x20, 0x56, 0xE4, 0x60, 0x20, 0xCF, 0x08, 0x20, 0xD5, 0x08, 0x60, 0x43, 0x3A, 0x9B, 0xFD, 0xE3,
    0xE1, 0xF2, 0xF4, 0xF2, 0xE9, 0xE4, 0xE7, 0xE5, 0xA0, 0xE9, 0xEE, 0xF3, 0xF4, 0xE1, 0xEC, 0xEC,
    0xE5, 0xE4, 0x1D, 0x9C, 0xF4, 0xF9, 0xF0, 0xE5, 0xA0, 0xBC, 0xC5, 0xD3, 0xC3, 0xBE, 0xA0, 0xF4,
    0xEF, 0xA0, 0xE3, 0xEF, 0xEE, 0xF4, 0xE9, 0xF5, 0xE5, 0xA0, 0xE2, 0xEF, 0xEF, 0xF4, 0xFD, 0x9B,
    };
/*--------------------------------------------------------------------*/
void addRecord(const U8 *record, U8 mode, FILE *pf)
{
	const U8 datal[8]={'d', 'a', 't', 'a', 0x84, 0x00, 0x6C, 0x4B};
	const U8 datam[8]={'d', 'a', 't', 'a', 0x84, 0x00, 0xA6, 0x0B};
	const U8 datas[8]={'d', 'a', 't', 'a', 0x84, 0x00, 0xFA, 0x00};
	unsigned int i;
	switch (mode)
	{
		case 1: {fwrite(datam,sizeof(U8),sizeof(datam),pf);} break;
		case 2: {fwrite(datal,sizeof(U8),sizeof(datal),pf);} break;
		default: {fwrite(datas,sizeof(U8),sizeof(datas),pf);} break;	
	};
	fputc(0x55,pf);
	fputc(0x55,pf);
	if (record==NULL) // EOF
	{
		fputc(0xFE,pf);
		for (i=0; i<128; i++) {fputc(0x00,pf);};
		fputc(0xA9,pf);
	}
	else
	{
		unsigned int sum=0xA7;
		for (i=0; i<128; i++) 
		{
			sum+=record[i];
			if (sum>255)
			{
				sum&=0xFF;
				sum++;
			};
		};
		fputc(0xFC,pf);
		fwrite(record,sizeof(U8),128,pf);
		fputc(sum&0xFF,pf);
	};
};
/*--------------------------------------------------------------------*/
void addData(const U8 *buf, unsigned int size, FILE *pf)
{
	U8 record[128];
	U8 gap=2;
	unsigned int i,j,k,nor;
	if ((size%128)==0) {nor=size/128;} else {nor=(size/128)+1;};
	for (i=0; i<nor; i++)
	{
		for (j=0; j<128; j++) {record[j]=0;};
		if (i==(nor-1))
		{
			k=(size-(i*128));
		}
		else
		{
			k=128;
		};
		for (j=0; j<k; j++) {record[j]=buf[i*128+j];};
		addRecord(record,gap,pf);
		gap=0;
	};
	addRecord(NULL,gap,pf);
}
/*--------------------------------------------------------------------*/
void addHeader(FILE *pf)
{
	const U8 boud[8]={'b','a','u','d', 0x00, 0x00, 0x58, 0x02};
	const U8 header[]={'F','U','J','I',0x1D,0x00,0x00,0x00,'F','i','l','e',' ','w','a','s',
			' ','g','e','n','e','r','a','t','e','d',' ','b','y',' ','X','E','X','2','C','A','S'};	
	static U8 addheader=1;
	if (addheader)
	{
		fwrite(header,sizeof(U8),sizeof(header),pf);
		fwrite(boud,sizeof(U8),sizeof(boud),pf);
		addheader=0;
	};	
}
/*--------------------------------------------------------------------*/
unsigned int loadBIN(const char *filename, U8 *buf, unsigned int size)
{
	unsigned int ret=0;
	FILE *pf;
	pf=fopen(filename,"rb");
	if (pf)
	{
		ret=fread(buf,sizeof(U8),size,pf);
		fclose(pf);
	};
	return ret;
}
/*--------------------------------------------------------------------*/
int main(int argc, char *argv[])
{
	U8 buf[256*256];
    FILE *casfile;
    unsigned int size;
	printf("XEX2CAS v1.1 (c)GienekP\n");
	switch (argc)
	{
		case 3:
		{
			casfile=fopen(argv[2],"wb");
			if (casfile)
			{
				addHeader(casfile);
				addData(exma,sizeof(exma),casfile);
				size=loadBIN(argv[1],buf,sizeof(buf));
				addData(buf,size,casfile);
				fclose(casfile);
			};
		} break;
		case 4:
		{
			casfile=fopen(argv[3],"wb");
			if (casfile)
			{
				addHeader(casfile);
				size=loadBIN(argv[1],buf,sizeof(buf));
				addData(buf,size,casfile);
				size=loadBIN(argv[2],buf,sizeof(buf));
				addData(buf,size,casfile);
				fclose(casfile);
			};
		} break;
		default:
		{
			printf("use:\n");
			printf("   xex2cas file.xex filsecas\n");
			printf("   xex2cas loader.bin file.xex file.cas\n");		
		} break;
	};
	return 0;
}
/*--------------------------------------------------------------------*/
